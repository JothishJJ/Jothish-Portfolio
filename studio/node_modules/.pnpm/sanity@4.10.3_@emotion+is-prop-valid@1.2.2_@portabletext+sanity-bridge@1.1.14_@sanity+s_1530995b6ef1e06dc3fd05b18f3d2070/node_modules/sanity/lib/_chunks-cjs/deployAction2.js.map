{"version":3,"file":"deployAction2.js","sources":["../../src/_internal/cli/actions/deploy/deployAction.ts"],"sourcesContent":["/* eslint-disable max-statements */\nimport path from 'node:path'\nimport zlib from 'node:zlib'\n\nimport {type CliCommandArguments, type CliCommandContext} from '@sanity/cli'\nimport tar from 'tar-fs'\n\nimport {getAppId} from '../../util/getAppId'\nimport {shouldAutoUpdate} from '../../util/shouldAutoUpdate'\nimport buildSanityStudio, {type BuildSanityStudioCommandFlags} from '../build/buildAction'\nimport {deploySchemasAction} from '../schema/deploySchemasAction'\nimport {createManifestExtractor} from '../schema/utils/mainfestExtractor'\nimport {\n  checkDir,\n  createDeployment,\n  debug,\n  dirIsEmptyOrNonExistent,\n  getInstalledSanityVersion,\n  getOrCreateStudio,\n  getOrCreateUserApplicationFromConfig,\n  type UserApplication,\n} from './helpers'\n\nexport interface DeployStudioActionFlags extends BuildSanityStudioCommandFlags {\n  'build'?: boolean\n  'schema-required'?: boolean\n  'verbose'?: boolean\n}\n\nexport default async function deployStudioAction(\n  args: CliCommandArguments<DeployStudioActionFlags>,\n  context: CliCommandContext,\n): Promise<void> {\n  const {apiClient, workDir, chalk, output, prompt, cliConfig} = context\n  const flags = {build: true, ...args.extOptions}\n  const customSourceDir = args.argsWithoutOptions[0]\n  const sourceDir = path.resolve(process.cwd(), customSourceDir || path.join(workDir, 'dist'))\n  const isAutoUpdating = shouldAutoUpdate({flags, cliConfig, output})\n\n  const installedSanityVersion = await getInstalledSanityVersion()\n\n  const client = apiClient({\n    requireUser: true,\n    requireProject: true,\n  }).withConfig({apiVersion: 'v2024-08-01'})\n\n  if (customSourceDir === 'graphql') {\n    throw new Error('Did you mean `sanity graphql deploy`?')\n  }\n\n  if (customSourceDir) {\n    let relativeOutput = path.relative(process.cwd(), sourceDir)\n    if (relativeOutput[0] !== '.') {\n      relativeOutput = `./${relativeOutput}`\n    }\n\n    const isEmpty = await dirIsEmptyOrNonExistent(sourceDir)\n    const shouldProceed =\n      isEmpty ||\n      (await prompt.single({\n        type: 'confirm',\n        message: `\"${relativeOutput}\" is not empty, do you want to proceed?`,\n        default: false,\n      }))\n\n    if (!shouldProceed) {\n      output.print('Cancelled.')\n      return\n    }\n\n    output.print(`Building to ${relativeOutput}\\n`)\n  }\n\n  // Check that the project has a studio hostname\n  let spinner = output.spinner('Checking project info').start()\n\n  const appId = getAppId({cliConfig, output})\n  const configStudioHost = cliConfig && 'studioHost' in cliConfig ? cliConfig.studioHost : undefined\n\n  let userApplication: UserApplication\n  try {\n    // If the user has provided an appId in the config, use that\n    if (appId || configStudioHost) {\n      userApplication = await getOrCreateUserApplicationFromConfig({\n        client,\n        context,\n        spinner,\n        ...(appId ? {appId, appHost: undefined} : {appId: undefined, appHost: configStudioHost}),\n      })\n    } else {\n      userApplication = await getOrCreateStudio({client, context, spinner})\n    }\n  } catch (err) {\n    if (err.message) {\n      output.error(chalk.red(err.message))\n      return\n    }\n\n    debug('Error creating user application', err)\n    throw err\n  }\n\n  // Always build the project, unless --no-build is passed\n  const shouldBuild = flags.build\n  if (shouldBuild) {\n    const buildArgs = {\n      ...args,\n      extOptions: flags,\n      argsWithoutOptions: [customSourceDir].filter(Boolean),\n    }\n    const {didCompile} = await buildSanityStudio(buildArgs, context, {basePath: '/'})\n\n    if (!didCompile) {\n      return\n    }\n  }\n\n  await deploySchemasAction(\n    {\n      'extract-manifest': shouldBuild,\n      'manifest-dir': `${sourceDir}/static`,\n      'schema-required': flags['schema-required'],\n      'verbose': flags.verbose,\n    },\n    {...context, manifestExtractor: createManifestExtractor(context)},\n  )\n\n  // Ensure that the directory exists, is a directory and seems to have valid content\n  spinner = output.spinner('Verifying local content').start()\n  try {\n    await checkDir(sourceDir)\n    spinner.succeed()\n  } catch (err) {\n    spinner.fail()\n    debug('Error checking directory', err)\n    throw err\n  }\n\n  // Now create a tarball of the given directory\n  const parentDir = path.dirname(sourceDir)\n  const base = path.basename(sourceDir)\n  const tarball = tar.pack(parentDir, {entries: [base]}).pipe(zlib.createGzip())\n\n  spinner = output.spinner('Deploying to sanity.studio').start()\n  try {\n    const {location} = await createDeployment({\n      client,\n      applicationId: userApplication.id,\n      version: installedSanityVersion,\n      isAutoUpdating,\n      tarball,\n    })\n\n    spinner.succeed()\n\n    // And let the user know we're done\n    output.print(`\\nSuccess! Studio deployed to ${chalk.cyan(location)}`)\n\n    if (!appId) {\n      const example = `Example:\nexport default defineCliConfig({\n  //…\n  deployment: {\n    ${chalk.cyan`appId: '${userApplication.id}'`},\n  },\n  //…\n})`\n      output.print(`\\nAdd ${chalk.cyan(`appId: '${userApplication.id}'`)}`)\n      output.print(`to the \\`deployment\\` section in sanity.cli.js or sanity.cli.ts`)\n      output.print(`to avoid prompting for application id on next deploy.`)\n      output.print(`\\n${example}`)\n    }\n  } catch (err) {\n    spinner.fail()\n    debug('Error deploying studio', err)\n    throw err\n  }\n}\n"],"names":["deployStudioAction","args","context","apiClient","workDir","chalk","output","prompt","cliConfig","flags","build","extOptions","customSourceDir","argsWithoutOptions","sourceDir","path","resolve","process","cwd","join","isAutoUpdating","shouldAutoUpdate","installedSanityVersion","getInstalledSanityVersion","client","requireUser","requireProject","withConfig","apiVersion","Error","relativeOutput","relative","dirIsEmptyOrNonExistent","single","type","message","default","print","spinner","start","appId","getAppId","configStudioHost","studioHost","undefined","userApplication","getOrCreateUserApplicationFromConfig","appHost","getOrCreateStudio","err","error","red","debug","shouldBuild","buildArgs","filter","Boolean","didCompile","buildSanityStudio","basePath","deploySchemasAction","verbose","manifestExtractor","createManifestExtractor","checkDir","succeed","fail","parentDir","dirname","base","basename","tarball","tar","pack","entries","pipe","zlib","createGzip","location","createDeployment","applicationId","id","version","cyan","example"],"mappings":"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"}