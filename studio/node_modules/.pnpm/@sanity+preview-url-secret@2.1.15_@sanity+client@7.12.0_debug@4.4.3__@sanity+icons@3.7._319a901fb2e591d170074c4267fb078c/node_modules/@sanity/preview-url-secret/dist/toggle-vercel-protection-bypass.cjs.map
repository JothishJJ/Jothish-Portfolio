{"version":3,"file":"toggle-vercel-protection-bypass.cjs","sources":["../src/toggleVercelProtectionBypass.ts"],"sourcesContent":["import type {SanityClient, SyncTag} from '@sanity/client'\nimport {\n  vercelProtectionBypassSchemaId as _id,\n  vercelProtectionBypassSchemaType as _type,\n  fetchVercelProtectionBypassSecret,\n  tag,\n} from './constants'\nimport type {SanityClientLike} from './types'\n\n/** @internal */\nexport async function enableVercelProtectionBypass(\n  client: SanityClient,\n  secret: string,\n): Promise<void> {\n  const patch = client.patch(_id).set({secret})\n  await client.transaction().createIfNotExists({_id, _type}).patch(patch).commit({tag})\n}\n\n/** @internal */\nexport async function disableVercelProtectionBypass(client: SanityClient): Promise<void> {\n  const patch = client.patch(_id).set({secret: null})\n  await client.transaction().createIfNotExists({_id, _type}).patch(patch).commit({tag})\n}\n\n/** @internal */\nexport function subcribeToVercelProtectionBypass(\n  client: SanityClient,\n  onChange: (secret: string | null) => void,\n): () => void {\n  let controller = new AbortController()\n  let usedTags: SyncTag[] = []\n  async function fetchSecret(lastLiveEventId: string | null, signal: AbortSignal) {\n    const {result, syncTags} = await client.fetch<string | null>(\n      fetchVercelProtectionBypassSecret,\n      {},\n      {\n        filterResponse: false,\n        lastLiveEventId,\n        tag: 'preview-url-secret.fetch-vercel-bypass-protection-secret',\n      },\n    )\n    if (Array.isArray(syncTags)) {\n      usedTags = syncTags\n    }\n    if (!signal.aborted) {\n      onChange(result)\n    }\n  }\n  const subscription = client.live.events().subscribe({\n    next: (event) => {\n      if (event.type === 'message') {\n        controller.abort()\n        controller = new AbortController()\n        if (event.tags.some((tag) => usedTags.includes(tag))) {\n          fetchSecret(event.id, controller.signal)\n        }\n      }\n    },\n    // eslint-disable-next-line no-console\n    error: (reason) => console.error(reason),\n  })\n\n  fetchSecret(null, controller.signal)\n\n  return () => {\n    subscription.unsubscribe()\n    controller.abort()\n  }\n}\n\nexport type {SanityClientLike}\n"],"names":["_id","_type","tag","fetchVercelProtectionBypassSecret"],"mappings":";;;AAUA,eAAsB,6BACpB,QACA,QACe;AACf,QAAM,QAAQ,OAAO,MAAMA,UAAAA,8BAAG,EAAE,IAAI,EAAC,QAAO;AAC5C,QAAM,OAAO,YAAA,EAAc,kBAAkB,EAAA,KAACA,UAAAA,gCAAA,OAAKC,UAAAA,kCAAM,EAAE,MAAM,KAAK,EAAE,OAAO,EAAA,KAACC,UAAAA,KAAI;AACtF;AAGA,eAAsB,8BAA8B,QAAqC;AACvF,QAAM,QAAQ,OAAO,MAAMF,UAAAA,8BAAG,EAAE,IAAI,EAAC,QAAQ,MAAK;AAClD,QAAM,OAAO,YAAA,EAAc,kBAAkB,EAAA,KAACA,UAAAA,gCAAA,OAAKC,UAAAA,kCAAM,EAAE,MAAM,KAAK,EAAE,OAAO,EAAA,KAACC,UAAAA,KAAI;AACtF;AAGO,SAAS,iCACd,QACA,UACY;AACZ,MAAI,aAAa,IAAI,gBAAA,GACjB,WAAsB,CAAA;AAC1B,iBAAe,YAAY,iBAAgC,QAAqB;AAC9E,UAAM,EAAC,QAAQ,aAAY,MAAM,OAAO;AAAA,MACtCC,UAAAA;AAAAA,MACA,CAAA;AAAA,MACA;AAAA,QACE,gBAAgB;AAAA,QAChB;AAAA,QACA,KAAK;AAAA,MAAA;AAAA,IACP;AAEE,UAAM,QAAQ,QAAQ,MACxB,WAAW,WAER,OAAO,WACV,SAAS,MAAM;AAAA,EAEnB;AACA,QAAM,eAAe,OAAO,KAAK,OAAA,EAAS,UAAU;AAAA,IAClD,MAAM,CAAC,UAAU;AACX,YAAM,SAAS,cACjB,WAAW,MAAA,GACX,aAAa,IAAI,gBAAA,GACb,MAAM,KAAK,KAAK,CAACD,SAAQ,SAAS,SAASA,IAAG,CAAC,KACjD,YAAY,MAAM,IAAI,WAAW,MAAM;AAAA,IAG7C;AAAA;AAAA,IAEA,OAAO,CAAC,WAAW,QAAQ,MAAM,MAAM;AAAA,EAAA,CACxC;AAED,SAAA,YAAY,MAAM,WAAW,MAAM,GAE5B,MAAM;AACX,iBAAa,YAAA,GACb,WAAW,MAAA;AAAA,EACb;AACF;;;;"}