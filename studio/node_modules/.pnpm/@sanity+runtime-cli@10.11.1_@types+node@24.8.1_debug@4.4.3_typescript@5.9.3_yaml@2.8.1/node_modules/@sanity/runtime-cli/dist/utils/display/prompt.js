import chalk from 'chalk';
import inquirer from 'inquirer';
import { createEmptyStack, listStacks } from '../../actions/blueprints/stacks.js';
import { groupProjectsByOrganization } from '../../actions/sanity/projects.js';
import { niceId } from './presenters.js';
/**
 * Prompt the user for a Project after selecting an Organization.
 * @param token - The Sanity API token
 * @returns The selected project, with the projectId and displayName
 * @throws {Error} If the user does not have any projects or if the API call fails
 */
export async function promptForProject({ token, knownOrganizationId, knownProjectId, }) {
    const { ok, error, organizations } = await groupProjectsByOrganization({ token });
    if (!ok) {
        throw new Error(error ?? 'Unknown error listing projects');
    }
    if (organizations.length === 0) {
        throw new Error('No Sanity projects found. Use `npx sanity init` to create one.');
    }
    let projects;
    if (organizations.length > 1) {
        const orgChoices = organizations.map(({ organization, projects }) => ({
            name: `"${organization.name}" ${niceId(organization.id)}`,
            value: { organization, projects },
            disabled: !projects || projects.length === 0 ? '(0 Projects)' : false,
        }));
        const { pickedOrganization } = await inquirer.prompt([
            {
                type: 'list',
                name: 'pickedOrganization',
                message: 'Which Organization would you like to use?',
                choices: orgChoices,
                default: knownOrganizationId,
            },
        ]);
        projects = pickedOrganization.projects;
    }
    else {
        projects = organizations[0].projects;
    }
    const projectChoices = projects.map(({ displayName, id: projectId }) => ({
        name: `"${displayName}" ${niceId(projectId)}`,
        value: { projectId, displayName },
    }));
    const { pickedProject } = await inquirer.prompt([
        {
            type: 'list',
            name: 'pickedProject',
            message: 'Choose a Sanity Project:',
            choices: projectChoices,
            default: knownProjectId,
        },
    ]);
    return pickedProject;
}
export async function promptForStackId({ projectId, token, }) {
    const { ok: stacksOk, error: stacksErr, stacks, } = await listStacks({ token, scopeType: 'project', scopeId: projectId });
    if (!stacksOk) {
        throw new Error(stacksErr || 'Failed to list Stacks');
    }
    const stackChoices = [
        { name: chalk.bold('âœ¨ Create a new Stack'), value: 'new' },
    ];
    if (stacks.length > 0) {
        stackChoices.push(new inquirer.Separator(chalk.underline('Use an existing Stack:')));
        stackChoices.push(...stacks.map((s) => ({
            name: `"${s.name}" ${niceId(s.id)} ${chalk.dim(`(${s.resources.length} res)`)}`,
            value: s.id,
        })));
    }
    const { pickedStackId } = await inquirer.prompt([
        {
            type: 'list',
            name: 'pickedStackId',
            message: 'Select an existing deployment or create a new one:',
            choices: stackChoices,
        },
    ]);
    if (pickedStackId === 'new') {
        const { stackName } = await inquirer.prompt([
            {
                type: 'input',
                name: 'stackName',
                message: 'Enter a name for your Stack:',
                validate: (input) => input.length > 0 || 'Stack name is required',
            },
        ]);
        const stack = await createEmptyStack({
            token,
            scopeType: 'project',
            scopeId: projectId,
            name: stackName,
        });
        return stack.id;
    }
    return pickedStackId;
}
